> ### chapter 3. 프로세스와 스레드
> #### 04. 스레드

### 1. 스레드의 개념
#### 1.1 스레드의 정의
- 안심스테이크를 만드는 과정
   - 요리 작업 전체(프로세스)
   - 준비 과정(프로세스 생성)
   레시피 준비, 고기와 채소, 칼 집게 등 조리 도구 준비
   - 요리 과정(스레드)
   요리 완성을 위해 레시피의 정해진 절차에 따라 수행되는 각각의 조리
   
- 프로세스 작업 과정
   > 1) 운영체제가 코드와 데이터를 메모리에 가져오고,
   > 2) 프로세스 제어 블록(PCB)를 생성
   > 3) 작업에 필요한 메모리 영역 확보
   > 4) 준비된 프로세스를 준비큐에 삽입
   > 5) 프로세스가 생성되면 CPU 스케쥴러는 프로세스가 해야할 일을 CPU에 전달 
   > 
   >     → 5번째 단계에서 CPU 스케줄러가 CPU에 전달하는 일 하나가 `스레드`
   >     
   > 6) 실제 작업은 CPU가 수행
    

- 운영체제와 CPU의 작업 단위
   - 운영체제 입장에서의 작업 단위: `프로세스`
   - CPU가 처리하는 작업의 단위
   : `프로세스로부터 전달받은 스레드`, 프로세스의 코드에 정의된 절차에 따라 CPU에 작업 요청을 하는 실행 단위
   
- 단일 스레드와 멀티 스레드
   - 한 요리사가 모든 일을 맡아서 하는 경우, 
   → **1개의 프로세스에 1개의 스레드**를 가진 `단일스레드`
   - 고기 굽는 A요리사, 채소 굽는 B요리사가 함께 요리를 하는 경우, 
   → **1개의 프로세스에 2개의 스레드**를 가진 `멀티스레드`
   

> #### cf. 작업의 크기
- 작은 단위의 일(operation)이 모여서 하나의 작업(task)가 된다.
- 작업을 상대적 크기 순으로 나열했을 때,
   `처리(job) > 프로세스(task) > 스레드(operation)`
   - 이 때, 여러 프로세스를 모아서 한꺼번에 처리하는 방법을 `일괄 작업(batch job)`이라고 한다.


#### 1.2 프로세스와 스레드의 차이
- **독립적인** 프로세스
   - `프로세스`끼리는 **약하게 연결**되어 있다.
   - 각 프로세스는 서로 큰 영향을 미치지 않기 때문에 실행 순서를 바꿀 수 있다.
   - `멀티태스크`
      - 여러 개의 프로세스로 구성
      - `서로 독립적`인 프로세스들
         - 하나의 프로세스가 비정상적 종료되어도, 다른 프로세스는 정상적으로 작동
         - IPC(프로세스간 통신)을 이용해 데이터를 주고 받는다.


- **서로 강하게 연결된** 스레드
   - `스레드`끼리는 **강하게 연결**되어 있다. 
   - 하나의 프로세스는 여러 개의 스레드로 구성
      - 이 스레드들은 강하게 연결되어 있다.
   - 따라서 순서를 바꾸어 실행해서는 안된다. 
   - `멀티스래드`
      - 하나의 프로세스에 여러 개의 스레드로 구성
      - `강하게 연결`된 스레드들
         - 스레드가 속한 프로세스가 종료되면, 프로세스 내 스레드들도 강제 종료된다.
         - 변수나 파일 등을 공유하고, 전역 변수나 함수 호출 등의 방법을 이용해 스레드 간 통신을 한다.
         
#### 1.3 스레드 관련 용어
> 프로세스와 스레드의 차이점을 중심으로 스레드 관련 용어 정리

- 멀티스레드
   - 프로세스 내 작업을 여러개의 스레드로 분할
   - 이를 통해 작업의 부담을 줄인다.

- 멀티태스킹
   - 운영체제가 CPU에 작업을 줄 때, 시간을 잘게 나누어 배분
   - 시분할 시스템(time-sharing system)
   - 시분할 시스템에서 운영체제가 CPU에 주는 작업은 `스레드` 이다. (프로세스 X)
   
- 멀티프로세싱
   - 여러 개의 CPU를 사용하여 여러 개의 스레드를 동시에 처리하는 작업 환경
      - 병렬 처리에서의 슈퍼스칼라 기법과 동일
   - `하나의 컴퓨터에 여러개의 CPU` 또는 `하나의 CPU 내 여러 개의 코어`에 **스레드를 배정**하여 동시에 작동
   - cf. 네트워크로 연결된 여러 컴퓨터에 스레드를 나누어 협업하는 분산 시스템도 멀티프로세싱
   
- CPU 멀티스레드
   - 한 번에 하나씩 처리해야하는 스레드를 파이프라인 기법을 이용해 동시에 여러 스레드를 처리하도록 만든 병렬 처리 기법
   - `하드웨어적인` 방법으로 하나의 CPU에서 여러 스레드를 동시에 처리하는 병렬 처리 기법
   
      - cf. 프로세스의 멀티스레드: 운영체제가 `소프트웨어적으로` 프로세스를 작은 단위의 스레드로 분할하여 운영하는 기법


### 2. 멀티스레드의 구조와 예
#### 2.1 멀티스레드의 구조
- 순차적으로 실행되는 초기의 프로그래밍 언어의 한계
   - 프로세스로 여러 개의 작업을 동시에 처리하기 불편
      - fork() 시스템 호출을 하영해 부모와 똑같은 프로세스 생성
      - exec() 시스템 호출로 프로세스를 전환하는 방법 
  
   - 여러 개의 작업을 동시에 진행해야하는 경우, `fork() 시스템 호출`의 낭비적 요소
      - fork() 시스템 호출로 프로세스를 복사하면, 코드 영역과 데이터영역의 일부가 메모리에 중복되어 존재
      - 부모-자식 관계이지만 서로 독립적인 프로세스이므로, 이러한 낭비 요소 제거 불가능
      
- 멀티태스킹의 낭비 요소를 제거하기 위한, **`스레드`**
   - 비슷한 일을 하는 2개의 프로세스를 만드는 대신, 
   - 한 프로세스 내 여러 스레드들이 코드, 데이터등을 공유하면서 여러 개의 일을 수행
   
- 프로세스의 정적 영역과 동적 영역
   - 정적인 영역
      - 프로세스가 실행되는 동안 바뀌지 않는 영역
      - `멀티태스킹` 시, fork() 시스템 호출로 여러개의 프로세스를 만들게 되면 필요없는 정적 영역이 여러 개 생성된다.
      
      
   - 동적인 영역
     - 스레드가 작업을 하면서 값이 바뀌거나 새로 만들어지거나 사라지는 영역
     - `멀티스레드` 시, **같은 프로세스 내 스레드들은 프로세스의 정적인 영역(코드, 파일, 전역데이터 등)의 자원을 공유**함으로써 **자원 낭비를 막고 효율성 향상**
     - ex) 레지스터 값, 스택, 힙 등
   
   > 위와 같은 맥락에서,
  > - 스레드:  `가벼운 프로세스(Light Weight Process, LWP)`
  > - 스레드가 1개인 일반 프로세스: `무거운 프로세스(Heavy Weight Process, HWP)`
   
   - 이러한 이유로, 
      - 단일 프로세스를 생성해 작업하는 것 보다, 
      하나의 프로세스에 여러 스레드를 생성해 작업을 하는 것이 메모리 낭비를 줄이고 자원을 효율적으로 사용할 수 있다.
     
      - 그래서 첫번째로 프로세스를 실행할 때는 천천히 실행되지만, 
      두번째 부터는 공유하고 있는 정적 영역은 제외하고 동적인 영역만 가지고 있는 스레드가 실행되므로 빠르게 실행되는 것
      
      
### 3. 멀티스레드의 장단점
#### 3.1 멀티스레드의 장점
> **1. 응답성 향상**
> - 한 스레드가 입출력으로 인해 작업이 진행되지 않더라도, 다른 스레드가 작업을 계속하여 사용자의 작업 요구에 빨리 응답할 수 있다.
> 
> **2. 자원 공유**
> - 한 프로세스 내에서 독립적인 스레드를 생성하면, 프로세스가 가진 자원을 모든 스레드가 공유하게 되어 작업을 원활하게 진행할 수 있다.
>
> **3. 효율성 향상**
> - 여러 개의 프로세스를 생성하는 것과 달리, 멀티스레드는 불필요한 자원의 중복을 막음으로써 시스템의 효율이 향상된다.
>
> **4. 다중 CPU 지원**
> - 2개 이상의 CPU를 가진 컴퓨터에서 멀티스레드를 사용하면, 다중 CPU가 멀티 스레드를 동시에 처리하여 CPU 사용량이 증가하고, 프로세스의 처리 시간이 단축된다.

- 프로세스 내 공유가 가능한 부분을 제외하고(ex. 프로세스의 정적인 영역) 실행과 관련된 부분(ex. 프로세스의 동적인 영역)을 스레드로 나누어 관리하면, 자원의 중복 사용을 피함으로써 낭비를 막을 수 있다.
- 또한, 하나의 프로세스에서 여러 스레드를 사용하면 작업의 효율을 높일 수 있다.


#### 3.2 멀티스레드의 단점
- 여러 개의 프로세스를 사용하는 것은 낭비요소가 있기 때문에 멀티스레드를 사용하지만, 이것이 단점으로 작용하기도 한다.
- 멀티스레드
   - 모든 스레드가 자원을 공유하기 때문에 
   - 하나의 스레드가 문제가 생기면, 전체 프로세스에 영향을 미친다.
- 멀티태스킹
  - 프로세스를 여러개 만드는 방식은 각 프로세스가 독립적이므로, 하나의 프로세스에서 문제가 생겨도 다른 프로세스로 문제가 전달되지 않는다.
  - 메모리가 넉넉하고, 멀티코어 CPU가 대중화 되어 여러개의 프로세스를 여러개의 CPU에서 동시에 실행할 수 있는 환경에서는 
     - 멀티스레드의 문제점을 최소화하기 위해 낭비요소가 있더라도 멀티스레드 대신 멀티태스킹을 이용한다. (ex. 구글 크롬)
     
### 4. 멀티스레드 모델
> 프로세스는 커널 프로세스와 사용자 프로세스로 나뉘며, 
스레드에도 커널 스레드와 사용자 스레드가 있다.

- `커널 스레드`: 커널이 직접 생성하고 관리하는 스레드
- `사용자 스레드`: 라이브러리에 의해 구현된 일반적인 스레드


